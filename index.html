<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProfitTracker</title>
    <meta name="description" content="Track your piece-rate earnings and expenses">
    <meta name="theme-color" content="#2b5797">

    <!-- iOS PWA Support -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" sizes="192x192" href="images/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="images/icon-512x512.png">
    <link rel="apple-touch-icon" sizes="180x180" href="images/icon-180x180.png">

    <link rel="manifest" href="manifest.json">

    <!-- Modular CSS files -->
    <link rel="stylesheet" href="styles/base.css">
    <link rel="stylesheet" href="styles/forms.css">
    <link rel="stylesheet" href="styles/entries.css">
    <link rel="stylesheet" href="styles/locations.css">
    <link rel="stylesheet" href="styles/controls.css">
    <link rel="stylesheet" href="styles/maps.css">
    <link rel="stylesheet" href="styles/utilities.css">

    <link rel="icon" href="images/favicon.ico">

    <style>
        /* Password Toggle Styles */
        .password-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .password-input-container input {
            padding-right: 45px;
            flex: 1;
        }

        .password-toggle {
            position: absolute;
            right: 10px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }

        .password-toggle:hover {
            opacity: 1;
        }

        .password-toggle:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }
    </style>
</head>

<body>
    <header>
        <h1>ProfitTracker</h1>
        <div id="header-controls">
            <div id="date-display"></div>
            <div id="sync-status" style="display: none;">
                <span id="sync-indicator">‚ö°</span>
                <span id="sync-text">Synced</span>
            </div>
            <div id="auth-section">
                <div id="auth-status" style="display: none;">
                    <div id="user-info"></div>
                    <button id="sign-out-btn" class="auth-btn">Sign Out</button>
                </div>
                <div id="auth-buttons">
                    <button id="sign-in-toggle-btn" class="auth-btn">Email Sign In</button>
                </div>
                <div id="email-auth-form" style="display: none;">
                    <input type="email" id="auth-email" placeholder="Email" required>
                    <div class="password-input-container">
                        <input type="password" id="auth-password" placeholder="Password" required>
                        <button type="button" class="password-toggle" onclick="togglePassword('auth-password')">
                            <span class="password-icon" id="auth-password-icon">üëÅÔ∏è</span>
                        </button>
                    </div>
                    <div>
                        <button id="sign-in-email-btn" class="auth-btn">Sign In</button>
                        <button id="sign-up-email-btn" class="auth-btn">Sign Up</button>
                        <button id="cancel-email-btn" class="auth-btn">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main>
        <!-- Pay Period Controls -->
        <!-- Add this section below your date display -->
        <section id="pay-period-section">
            <h2>Pay Period</h2>
            <div id="pay-period-controls">
                <div class="pay-period-display">
                    Current: <span id="current-pay-period"></span>
                </div>
                <div class="pay-period-nav">
                    <button id="prev-pay-period">‚Üê Previous</button>
                    <input type="date" id="pay-period-start" style="display: none;">
                    <button id="next-pay-period">Next ‚Üí</button>
                </div>
            </div>
            <div id="pay-period-summary">
                <!-- Pay period totals will be displayed here -->
            </div>
            <div id="file-gen-buttons">
                <button id="generate-travel-sheet">Generate Travel Sheet</button>
                <div id="map-generation-section">
                    <h4>Map Generation</h4>
                    <div id="map-grouping-options">
                        <label>Group maps by:</label>
                        <div class="radio-group">
                            <label><input type="radio" name="map-grouping" value="day"> Day</label>
                            <label><input type="radio" name="map-grouping" value="week"> Week</label>
                            <label><input type="radio" name="map-grouping" value="period" checked> Pay Period</label>
                        </div>
                    </div>
                    <button id="generate-map">Generate Maps</button>
                </div>
            </div>
        </section>

        <!-- Daily Entry Form -->
        <section id="daily-entry">
            <h2 class="form-group" id="de-heading">Daily Entry</h2>

            <div class="form-group" id="de-date">
                <label for="work-date">Date:</label>
                <input type="date" id="work-date" required>
            </div>

            <div class="form-group" id="de-points">
                <label for="points">Points Earned:</label>
                <input type="number" id="points" min="0" step="0.01">
            </div>

            <div class="form-group" id="de-kms">
                <label for="kms">Kilometers Driven:</label>
                <input type="number" id="kms" min="0" step="0.1">
            </div>

            <div class="form-group" id="de-perdiem">
                <label>Per Diem Earned:</label>
                <div class="radio-group">
                    <label><input type="radio" name="per-diem" value="full"> Full Per Diem <span
                            id="full-perdiem-amount">($171)</span></label>
                    <label><input type="radio" name="per-diem" value="partial"> Partial Per Diem <span
                            id="partial-perdiem-amount">($46)</span></label>
                    <label><input type="radio" name="per-diem" value="none" checked> No Per Diem ($0)</label>
                </div>
            </div>

            <!-- Expenses Section -->
            <div class="form-group" id="de-expenses">
                <h3>Expenses</h3>
                <div class="expenses-inputs">
                    <div class="expense-item">
                        <label for="hotel-expense">Hotel ($):</label>
                        <input type="number" id="hotel-expense" min="0" step="0.01" placeholder="0.00">
                    </div>
                    <div class="expense-item">
                        <label for="gas-expense">Gas ($):</label>
                        <input type="number" id="gas-expense" min="0" step="0.01" placeholder="0.00">
                    </div>
                    <div class="expense-item">
                        <label for="food-expense">Food ($):</label>
                        <input type="number" id="food-expense" min="0" step="0.01" placeholder="0.00">
                    </div>
                </div>
            </div>

            <div class="form-group" id="de-landlocs">
                <h3>Locations</h3>
                <sub>CC, town names, or land locations work</sub>
                <sub>Use ‚â° handle to reorder, √ó button to delete</sub>
                <div id="landlocs">

                </div>
                <button id="addloc">Add Location</button>
            </div>

            <div class="form-group" id="de-notes">
                <label for="notes">Notes:</label>
                <textarea id="notes" rows="3"></textarea>
            </div>
            <div class="form-group" id="de-buttons">
                <button id="save-entry">Save Entry</button>
                <button id="clear-form">Clear Form</button>
            </div>
        </section>

        <!-- Today's Earnings Display -->
        <section id="earnings-summary">
            <h2>Today's Earnings</h2>
            <div id="earnings-display">
                <!-- Earnings will be displayed here -->
            </div>
        </section>

        <!-- Past Entries List -->
        <section id="past-entries">
            <h2>Pay Period Entries</h2>
            <div id="entries-list">
                <!-- Past entries will be displayed here -->
            </div>
        </section>
    </main>

    <footer>
        <div id="settings-toggle">‚öôÔ∏è Settings</div>
        <div id="settings-panel" class="hidden">
            <h3>Settings</h3>
            <div class="form-group">
                <label for="point-rate">Rate per Point ($):</label>
                <input type="number" id="point-rate" min="0" step="0.25" value="6.25">
            </div>
            <div class="form-group">
                <label for="km-rate">Rate per Kilometer ($):</label>
                <input type="number" id="km-rate" min="0" step="0.01" value="0.88">
            </div>
            <div class="form-group">
                <label for="per-diem-full-rate">Full Per Diem Amount ($):</label>
                <input type="number" id="per-diem-full-rate" min="0" step="0.01" value="171">
            </div>
            <div class="form-group">
                <label for="per-diem-partial-rate">Partial Per Diem Amount ($):</label>
                <input type="number" id="per-diem-partial-rate" min="0" step="0.01" value="46">
            </div>
            <div class="form-group">
                <label for="gst-enabled">Include GST:</label>
                <input type="checkbox" id="gst-enabled" checked>
            </div>
            <div class="form-group">
                <label for="tech-code">Tech Code (format: C###):</label>
                <input type="text" id="tech-code" placeholder="e.g. C123, C456" maxlength="4" pattern="[A-Za-z]\d{3}">
                <small>Enter a letter followed by 3 digits</small>
            </div>
            <div class="form-group">
                <label for="gst-number">GST Number (optional):</label>
                <input type="text" id="gst-number" placeholder="e.g. 123456789RT0001" maxlength="15">
                <small>Business GST registration number</small>
            </div>
            <div class="form-group">
                <label for="business-name">Tech Name (optional):</label>
                <input type="text" id="business-name" placeholder="Your Name" maxlength="100">
                <small>Technician name for travel sheet</small>
            </div>
            <div class="form-group">
                <h3>‚ö†Ô∏è Danger Zone</h3>
                <button id="clear-all-data" class="sync-btn" style="background: var(--error-color); color: white;">üóëÔ∏è
                    Clear All Data</button>
                <small>Permanently delete ALL your entries and settings from both local storage and cloud</small>
            </div>
            <button id="save-settings">Save Settings</button>
        </div>
    </footer>

    <!-- Logout Progress Overlay -->
    <div id="logout-progress-overlay" class="modal-overlay" style="display: none; z-index: 10000;">
        <div class="modal" style="max-width: 400px; text-align: center;">
            <div class="modal-header">
                <h2>üîí Signing Out</h2>
            </div>
            <div class="modal-body">
                <div class="logout-spinner" style="margin: 20px 0;">
                    <div class="spinner"></div>
                </div>
                <div id="logout-status-text">Preparing to sign out...</div>
                <div class="logout-progress-steps" style="margin-top: 20px; text-align: left;">
                    <div class="progress-step" id="step-clearing-local">
                        <span class="step-icon">‚è≥</span> Clearing local data...
                    </div>
                    <div class="progress-step" id="step-clearing-cache">
                        <span class="step-icon">‚è≥</span> Clearing browser cache...
                    </div>
                    <div class="progress-step" id="step-firebase-signout">
                        <span class="step-icon">‚è≥</span> Signing out from Firebase...
                    </div>
                    <div class="progress-step" id="step-redirecting">
                        <span class="step-icon">‚è≥</span> Redirecting to login...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>

    <!-- Firebase Configuration -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendEmailVerification } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, setDoc, updateDoc, deleteDoc, getDocs, getDoc, onSnapshot, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAlVo_EYRnSTgnB55J-LRFpKG6ZGvA88_w",
            authDomain: "profittrackerccc.firebaseapp.com",
            projectId: "profittrackerccc",
            storageBucket: "profittrackerccc.firebasestorage.app",
            messagingSenderId: "272024960605",
            appId: "1:272024960605:web:bffdb40e154d4e7eac57b4"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Make Firebase services available globally
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseModules = {
            GoogleAuthProvider,
            signInWithPopup,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            sendEmailVerification,
            doc,
            collection,
            addDoc,
            setDoc,
            updateDoc,
            deleteDoc,
            getDocs,
            getDoc,
            onSnapshot,
            query,
            where,
            orderBy
        };

        console.log('üî• Firebase initialized successfully');
    </script>

    <!-- Database module -->
    <script src="scripts/db.js"></script>

    <!-- Utility modules -->
    <script src="scripts/dateUtils.js"></script>
    <script src="scripts/calculations.js"></script>

    <!-- Feature modules -->
    <script src="scripts/uiManager.js"></script>
    <script src="scripts/settingsManager.js"></script>
    <script src="scripts/locationManager.js"></script>
    <script src="scripts/entryManager.js"></script>
    <script src="scripts/communityCodes.js"></script>
    <script src="scripts/mapGenerator.js"></script>

    <!-- Firebase and authentication -->
    <script src="scripts/authManager.js"></script>
    <script src="scripts/cloudStorage.js"></script>
    <script src="scripts/migrationManager.js"></script>
    <script src="scripts/syncManager.js"></script>

    <!-- Travel sheet generation modules -->
    <script src="scripts/excelManager.js"></script>
    <script src="scripts/travelSheetGenerator.js"></script>

    <!-- Main application -->
    <script src="scripts/app.js"></script>

    <script>
        /**
         * Toggles password visibility for a given input field
         * @param {string} fieldId - The ID of the password input field
         */
        function togglePassword(fieldId) {
            const passwordField = document.getElementById(fieldId);
            const icon = document.getElementById(fieldId + '-icon');

            if (passwordField && icon) {
                if (passwordField.type === 'password') {
                    passwordField.type = 'text';
                    icon.textContent = 'üôà';
                    icon.setAttribute('aria-label', 'Hide password');
                } else {
                    passwordField.type = 'password';
                    icon.textContent = 'üëÅÔ∏è';
                    icon.setAttribute('aria-label', 'Show password');
                }
            }
        }

        // Add keyboard support for password toggles
        document.addEventListener('keydown', function (e) {
            if (e.target.classList.contains('password-toggle') && (e.key === 'Enter' || e.key === ' ')) {
                e.preventDefault();
                e.target.click();
            }
        });
    </script>

    <!-- Logout Progress Overlay -->
    <div id="logout-progress-overlay" class="modal-overlay" style="display: none; z-index: 10000;">
        <div class="modal" style="max-width: 400px; text-align: center;">
            <div class="modal-header">
                <h2>üîí Signing Out</h2>
            </div>
            <div class="modal-body">
                <div class="logout-spinner" style="margin: 20px 0;">
                    <div class="spinner"></div>
                </div>
                <div id="logout-status-text">Preparing to sign out...</div>
                <div class="logout-progress-steps" style="margin-top: 20px; text-align: left;">
                    <div class="progress-step" id="step-clearing-local">
                        <span class="step-icon">‚è≥</span> Clearing local data...
                    </div>
                    <div class="progress-step" id="step-clearing-cache">
                        <span class="step-icon">‚è≥</span> Clearing browser cache...
                    </div>
                    <div class="progress-step" id="step-firebase-signout">
                        <span class="step-icon">‚è≥</span> Signing out from Firebase...
                    </div>
                    <div class="progress-step" id="step-redirecting">
                        <span class="step-icon">‚è≥</span> Redirecting to login...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * Toggles password visibility for a given input field
         * @param {string} fieldId - The ID of the password input field
         */
        function togglePassword(fieldId) {
            const passwordField = document.getElementById(fieldId);
            const icon = document.getElementById(fieldId + '-icon');

            if (passwordField && icon) {
                if (passwordField.type === 'password') {
                    passwordField.type = 'text';
                    icon.textContent = 'üôà';
                    icon.setAttribute('aria-label', 'Hide password');
                } else {
                    passwordField.type = 'password';
                    icon.textContent = 'üëÅÔ∏è';
                    icon.setAttribute('aria-label', 'Show password');
                }
            }
        }

        // Add keyboard support for password toggles
        document.addEventListener('keydown', function (e) {
            if (e.target.classList.contains('password-toggle') && (e.key === 'Enter' || e.key === ' ')) {
                e.preventDefault();
                e.target.click();
            }
        });
    </script>
</body>

</html>
<h2>üîí Signing Out</h2>
</div>
<div class="modal-body">
    <div class="logout-spinner" style="margin: 20px 0;">
        <div class="spinner"></div>
    </div>
    <div id="logout-status-text">Preparing to sign out...</div>
    <div class="logout-progress-steps" style="margin-top: 20px; text-align: left;">
        <div class="progress-step" id="step-clearing-local">
            <span class="step-icon">‚è≥</span> Clearing local data...
        </div>
        <div class="progress-step" id="step-clearing-cache">
            <span class="step-icon">‚è≥</span> Clearing browser cache...
        </div>
        <div class="progress-step" id="step-firebase-signout">
            <span class="step-icon">‚è≥</span> Signing out from Firebase...
        </div>
        <div class="progress-step" id="step-redirecting">
            <span class="step-icon">‚è≥</span> Redirecting to login...
        </div>
    </div>
</div>
</div>
</div>
</body>

</html>